<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content><meta name=keywords content="development,contributing"><meta property="og:url" content="https://docs.mysurvey.solutions/contributing/adding-new-question-type/"><meta property="og:site_name" content="Survey Solutions | Documentation"><meta property="og:title" content="Adding new question type"><meta property="og:description" content="Adding new question type Adding a new question type requires changes in all existing applications in survey solutions.
When implementing it think about an answers to the following questions:
What CLR type can be used to represent an answer to your question type. Consider existing types How do you see this question to be represented in export â€“ Is answer should be presented differently during preloading of assignments How will it be represented on UI for interviewer, headquarters (answered read-only state) Designer Entry point is enum QuestionType. To add new entry here or not depends on how much your new question type is different from any of the existing types. In order to be able to use answer to a question in questionnaire expressions implement a type conversion in QuestionTypeToCSharpTypeMapper. You should always choose a type that can have a null value in it."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="contributing"><meta property="article:modified_time" content="2021-07-01T11:41:05-04:00"><meta property="og:image" content="https://docs.mysurvey.solutions/img/logo.png"><link rel=icon href=/img/favicon/favicon-support-1.png type=image/png sizes=16x16><link rel=icon href=/img/favicon/favicon-support-1-48-win-ico.png type=image/png sizes=48x48><link rel=icon href=/img/favicon/favicon-support-1-158-General-use-iOS-Android.png type=image/png sizes=152x152><link rel=icon href=/img/favicon/favicon-support-1-196-Chrome-for-Android.png type=image/png sizes=196x196><link rel=icon href=/img/favicon/favicon-support-1-558-win10-tile.png type=image/png sizes=558x558><title>Adding new question type</title><link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css integrity=sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T crossorigin=anonymous><link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700,900&amp;subset=cyrillic,cyrillic-ext,greek,greek-ext,latin-ext,vietnamese" rel=stylesheet><link href=/css/all.css rel=stylesheet><link href=https://cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/5.3.0/ekko-lightbox.css rel=stylesheet></head><body><header class="px-md-3 pt-3"><div class=container><div class=row><div class="mb-3 col-lg-6 col-md-12"><a class="navbar-brand text-white pr-0 mr-0 float-left" href=https://mysurvey.solutions/ target=_blank><img src=/img/logo.png alt="Survey Solutions" class=float-left>
<span class="float-left ml-2">Survey<br>Solutions</span>
</a><a class="navbar-text text-white pl-sm-4 ml-sm-4 pl-2 ml-2 float-left" href=https://docs.mysurvey.solutions/>Documentation and knowledge base</a></div><script type=text/template id=my-custom-menu-template>
    <div class="aa">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="docs-tab" data-toggle="tab" href="#docs" role="tab" aria-controls="docs" aria-selected="true">Articles</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="forum-tab" data-toggle="tab" href="#forum" role="tab" aria-controls="forum" aria-selected="false">Forum topics</a>
            </li>
        </ul>
        <div class="tab-content">
            <div class="aa-dataset-docs tab-pane fade show active" id="docs" role="tabpanel" aria-labelledby="docs-tab"></div>
            <div class="aa-dataset-forum tab-pane fade" id="forum" role="tabpanel" aria-labelledby="forum-tab"></div>
        </div>
    </div>
</script><div class="col-lg-6 col-md-12 pt-2 mb-4 mb-lg-3"><form class=form-inline onsubmit=return!1><div class="input-group search"><input type=text class="form-control w-100" placeholder="Have a Question? Ask or enter a search term here." id=aa-search-input></div></form></div></div></div></header><main class="container mb-3"><nav aria-label=breadcrumb><ol class="breadcrumb bg-transparent pl-0"><li class=breadcrumb-item><a href=/>Home</a></li><li class=breadcrumb-item><a href=/contributing/>Contributing</a></li><li class="breadcrumb-item active" aria-current=page>Adding new question type</li></ol></nav><div class=mb-4><article class="article d-block w-100"><div class="mb-5 pb-1 d-block w-100 page-title d-flex align-items-end"><h2 class="mb-3 mr-auto pr-3">Adding new question type</h2><div class="data text-right">July 1, 2021</div></div><div class=article-content><h1 id=adding-new-question-type>Adding new question type</h1><p>Adding a new question type requires changes in all existing applications in survey solutions.</p><p>When implementing it think about an answers to the following questions:</p><ul><li>What CLR type can be used to represent an answer to your question type. Consider existing <a href=/syntax-guide/cslanguage/data-types/>types</a></li><li>How do you see this question to be represented in export
&ndash; Is answer should be presented differently during preloading of assignments</li><li>How will it be represented on UI for interviewer, headquarters (answered read-only state)</li></ul><h2 id=designer>Designer</h2><p>Entry point is <code>enum QuestionType</code>. To add new entry here or not depends on how much your new question type is different from any of the existing types.
In order to be able to use answer to a question in questionnaire expressions implement a type conversion in <code>QuestionTypeToCSharpTypeMapper</code>. You should always choose a type that can have a <code>null</code> value in it.</p><p>Extend <code>QuestionnaireInfoFactory</code>. This class is responsible to generate classes provided to a javascript view from <code>QuestionnaireDocument</code> object.</p><p>Implement needed UI to edit question details on designer. To do it introduce changes in <code>src\UI\WB.UI.Designer\questionnaire</code> folder. Start at <code>views/question.html</code>, <code>controllers/question.js</code> this is code that is generic to all question types. There you&rsquo;ll be able to find how customizations per type can be implemented. Client javascript application sends commands to <code>CommandController</code> so check if you need to introduce changes there.</p><p>If you need to store custom properties for your question type create new command that is going to be used in update operations. Find implementation of <code>UpdateTextQuestion</code> class as an example</p><p>Implement needed new verifications to be used during questionnaire compilation. <code>QuestionnaireVerifier</code> class is an entry point for all checks that are executed, check <code>QuestionVerifications</code> class for examples. Verifications are separated into 3 levels (<code>VerificationMessageLevel</code> enum) - <code>Critical</code>, <code>Error</code> and <code>Warning</code>.</p><ul><li><code>Critical</code> errors are first to be checked by verifier. If any critical error found in questionnaire its likely to break the entire questionnaire structure and will lead to more and more errors. So if any critical error is found further lower level checks are not executed.</li><li><code>Error</code> is regular error</li><li><code>Warning</code> is shows in separate list and not prevents user from importing questionnaire to headquarters application</li></ul><p>Once question can be saved on designer and verified implement its representation for PDF Export. <code>PdfFactory</code> class is responsible for preparing data to render document, views to render UI can be found in <code>src\UI\WB.UI.Designer\Areas\Pdf</code> folder. PDF file is generated from html with wkhtmltopdf tool.</p><p>In order to prevent older Headquarters applications from importing questionnaires that are using new question type extend <code>DesignerEngineVersionService</code> class with check for existence of a new type. Assign current <code>ApiVersion.MaxQuestionnaireVersion</code> to existing last check, increment later constant by 1 and use it to assign content version in your new check.</p><p>Do not forget to write unit test for all introduced changes.</p><h2 id=headquarters>Headquarters</h2><p>Headquarters application should be able to display added question type during interview review and give an ability to give answers when web mode is used.</p><p>At this point you&rsquo;ll need to implement an ability for interview to receive answers for that new question type.
Interview represents itself as a tree inside (<code>InterviewTree</code>). Each question has own type that stores answer and state if its disabled, valid, etc. You need to create a representation of your question type, create a new class, take a <code>InterviewTreeGpsQuestion</code> as an example. While adding question type for a tree you&rsquo;ll also create a type to store answer to your question type.
Now you should be able to add a new command, example can found at <code>AnswerGeographyQuestionCommand.cs</code>. After new class for command is created add a new method that will accept answer in <code>Interview.cs</code> file, take <code>AnswerAreaQuestion(AnswerGeographyQuestionCommand command)</code> as an example.
When that done you should be able to implement answering command. You&rsquo;ll need to extend <code>ApplyUpdateAnswerEvents</code> method in the <code>Interview</code> class to raise new event type for your question.</p><p>When interview is accepting answer and is raising proper event, implement UI for web mode. Extend class that converts interview entities into UI dtos - <code>WebInterviewInterviewEntityFactory</code>. Specifically <code>GetEntityDetails</code> method. Create needed dto classes for it.
Open <code>src/UI/WB.UI.Frontend</code> in visual studio code, create a new <code>vue</code> component in <code>src\webinterview\components\questions</code> folder. Existing convention maps component to a type declared in <code>WB.Enumerator.Native.WebInterview.Models.InterviewEntityType</code> enumeration. So extend it with new type and add appropriate <code>.vue</code> component (<code>Integer.vue</code> can be an example).</p><h3 id=preloading>Preloading</h3><p>Implement preloading for new question type. Its done in 2 phases:</p><ol><li>parsing and validating raw csv file for validity</li><li>verifying interview specific rules, question types and questions existence</li></ol><p>Code is located in <code>AssignmentsImportService.VerifySimpleAndSaveIfNoErrors</code> method. It checks file and stores it in rows to database for background process to pickup and create assignments.
When file is uploaded and stored <code>AssignmentsVerificationJob</code> validates it for interview specific rules, if needed extend it.
After validation assignment is created in <code>AssignmentsImportJob</code>. To parse string value into a proper answer value extend <code>AssignmentsImportService.ToInterviewAnswer</code> method.</p><h2 id=web-tester>Web tester</h2><p>If implemented properly should be working already since its using same code as web interview does.</p><h2 id=interviewersupervisor>Interviewer/Supervisor</h2><p>Start implementation from extending of <code>InterviewViewModelFactory</code>. Method <code>GetEntityModelType</code> converts questionnaire question type to question type that is mapped to a specific viewmodel (<code>GetEntityModelType</code>). Extend <code>InterviewEntityType</code> enum, <code>EntityTypeToViewModelMap</code> method and create new viewmodel type for new question.
Each question has generic functionalities like title, instructions, validations, warnings, comments etc. They are added by composition in parent viewmodel. Look for <code>TextQuestionViewModel</code> as an example of implementation.
Viewmodel should implement multiple interfaces to be fully supported by interviewer application:</p><ul><li><code>IInterviewEntityViewModel</code> - makes it possible for section viewmodel to track individual entities</li><li><code>IViewModelEventHandler&lt;TextQuestionAnswered></code> - viewmodel should update own ui when <code>Interview</code> accepted answer and pushed event about it back to interview</li><li><code>IViewModelEventHandler&lt;AnswersRemoved></code> - same as answered</li><li><code>ICompositeQuestion</code> - in order to achieve smooth scrolling each question is spitted into small rows. This interface allows for parent viewmodel to get a plain list of entities that question is composed of</li><li><code>IDisposable</code> - called when user leaves section to clear all managed resources, unsubscribe from evets.</li></ul><h2 id=export>Export</h2><p>Export development is done in separate solution - <code>src/Services/WB.Services.sln</code>. Extend <code>QuestionType</code> enum and add a type that will represent new question type in questionnaire document (same was as it was implemented in designer).
Extend <code>QuestionnaireSchemaGenerator.GetSqlTypeForQuestion</code> method that maps question type to PostgreSQL column type. If your question spans across multiple export columns (as multi option does for example) extend implementation of <code>QuestionnaireExportStructureFactory.FillHeaderWithQuestionsInsideGroup</code> method.</p></div></article></div></main><footer class="footer pt-3 pb-1 px-sm-3 px-lg-0"><div class="container copyright"><div class=float-left>&#169; 2016-2025 The World Bank Group.<br>All rights Reserved. <a href=https://www.worldbank.org/en/about/legal _target=blank>Legal</a><br><a class=text-primary href=/about/ _target=blank><b class=text-primary>About the team</b></a>
<a class=text-primary href=https://www.capterra.com/p/153927/Survey-Solutions/ target=_blank>Testimonials</a></div></div></footer><script src=https://code.jquery.com/jquery-3.3.1.min.js integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js></script><script src=https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.min.js></script><script src=/js/asearch.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/5.3.0/ekko-lightbox.min.js></script><script>$(document).on("click",'[data-toggle="lightbox"]',function(e){e.preventDefault(),$(this).ekkoLightbox({alwaysShowClose:!0})})</script></body></html>