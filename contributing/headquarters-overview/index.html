<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content><meta name=keywords content="headquarters,development,contributing"><meta property="og:url" content="https://docs.mysurvey.solutions/contributing/headquarters-overview/"><meta property="og:site_name" content="Survey Solutions | Documentation"><meta property="og:title" content="Headquarters application overview"><meta property="og:description" content="Headquarters application for developers Headquarters web application uses CQRS with event sourcing based architecture.
At a high level a change to the state of the system is done in the following sequence:
Client creates a command that describes what kind of change is needed Infrastructure restores aggregate root from its event stream Aggregate root checks if command execution is allowed and executes it Events produced by aggregate root are published to denormalizers to build reports, lists and any other representations for end user Sections below describe major aspects of Headquarters application that developers need to know about."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="contributing"><meta property="article:modified_time" content="2021-07-01T11:41:05-04:00"><meta property="og:image" content="https://docs.mysurvey.solutions/img/logo.png"><link rel=icon href=/img/favicon/favicon-support-1.png type=image/png sizes=16x16><link rel=icon href=/img/favicon/favicon-support-1-48-win-ico.png type=image/png sizes=48x48><link rel=icon href=/img/favicon/favicon-support-1-158-General-use-iOS-Android.png type=image/png sizes=152x152><link rel=icon href=/img/favicon/favicon-support-1-196-Chrome-for-Android.png type=image/png sizes=196x196><link rel=icon href=/img/favicon/favicon-support-1-558-win10-tile.png type=image/png sizes=558x558><title>Headquarters application overview</title><link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css integrity=sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T crossorigin=anonymous><link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700,900&amp;subset=cyrillic,cyrillic-ext,greek,greek-ext,latin-ext,vietnamese" rel=stylesheet><link href=/css/all.css rel=stylesheet><link href=https://cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/5.3.0/ekko-lightbox.css rel=stylesheet></head><body><header class="px-md-3 pt-3"><div class=container><div class=row><div class="mb-3 col-lg-6 col-md-12"><a class="navbar-brand text-white pr-0 mr-0 float-left" href=https://mysurvey.solutions/ target=_blank><img src=/img/logo.png alt="Survey Solutions" class=float-left>
<span class="float-left ml-2">Survey<br>Solutions</span>
</a><a class="navbar-text text-white pl-sm-4 ml-sm-4 pl-2 ml-2 float-left" href=https://docs.mysurvey.solutions/>Documentation and knowledge base</a></div><script type=text/template id=my-custom-menu-template>
    <div class="aa">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="docs-tab" data-toggle="tab" href="#docs" role="tab" aria-controls="docs" aria-selected="true">Articles</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="forum-tab" data-toggle="tab" href="#forum" role="tab" aria-controls="forum" aria-selected="false">Forum topics</a>
            </li>
        </ul>
        <div class="tab-content">
            <div class="aa-dataset-docs tab-pane fade show active" id="docs" role="tabpanel" aria-labelledby="docs-tab"></div>
            <div class="aa-dataset-forum tab-pane fade" id="forum" role="tabpanel" aria-labelledby="forum-tab"></div>
        </div>
    </div>
</script><div class="col-lg-6 col-md-12 pt-2 mb-4 mb-lg-3"><form class=form-inline onsubmit=return!1><div class="input-group search"><input type=text class="form-control w-100" placeholder="Have a Question? Ask or enter a search term here." id=aa-search-input></div></form></div></div></div></header><main class="container mb-3"><nav aria-label=breadcrumb><ol class="breadcrumb bg-transparent pl-0"><li class=breadcrumb-item><a href=/>Home</a></li><li class=breadcrumb-item><a href=/contributing/>Contributing</a></li><li class="breadcrumb-item active" aria-current=page>Headquarters application overview</li></ol></nav><div class=mb-4><article class="article d-block w-100"><div class="mb-5 pb-1 d-block w-100 page-title d-flex align-items-end"><h2 class="mb-3 mr-auto pr-3">Headquarters application overview</h2><div class="data text-right">July 1, 2021</div></div><div class=article-content><h1 id=headquarters-application-for-developers>Headquarters application for developers</h1><p>Headquarters web application uses CQRS with event sourcing based architecture.</p><p>At a high level a change to the state of the system is done in the following sequence:</p><ol><li>Client creates a command that describes what kind of change is needed</li><li>Infrastructure restores aggregate root from its event stream</li><li>Aggregate root checks if command execution is allowed and executes it</li><li>Events produced by aggregate root are published to denormalizers to build reports, lists and any other representations for end user</li></ol><p>Sections below describe major aspects of Headquarters application that developers need to know about.</p><h2 id=web-request-lifecycle>Web request lifecycle</h2><p>Each request in system passes a set of steps that developer should know about:</p><h3 id=determine-target-workspace>Determine target workspace</h3><p><code>WorkspaceMiddleware</code> check web request URL and list of created workspaces. If rules match it wraps web request into an inner Autofac scope where <code>IWorkspaceContextAccessor</code> can be resolved and client code knows workspace details that its working inside.
When workspace middleware sets asp.net <code>HttpContext.Request.Path</code> and <code>HttpContext.Request.PathBase</code>. This allows for all other infrastructure like routing and link builders not to think about prefix for workspace name in the URL.
In order to make all database queries to be executed in proper workspace set of NHibernate <code>ISessionFactory</code> objects is stored in <code>HqSessionFactoryFactory</code> class. Each has its connection string <code>SearchPath</code> property configured to match workspace.
To have access to workspace information in all views global action filter (<code>WorkspaceInfoFilter</code>) sets it into <code>ViewData</code> dictionary.</p><h3 id=request-transaction>Request transaction</h3><p><code>UnitOfWorkActionFilter</code> class begins transaction and commits it if no exception occurred during request execution. This transaction wraps calls that are made to data that is stored in <code>IPlainStorage</code> and <code>IPlainKeyValueStorage</code>.</p><h3 id=command-execution>Command execution</h3><p>Command that is sent into <code>CommandService</code> to be handled by aggregate root. Each command is handled inside its own scope so that events and denormalized data is stored in one transaction and either committed fully or rolled back.</p><p>Command is executed by <code>CommandExecutor</code> class and can be of two types - regular and stateless. Difference between the two is that stateless command does not restore aggregate root state from events. Example of stateless command is interview deletion that occurs when questionnaire is deleted. In such case reading each interview events and restore state would be a waste of resources.</p><p><code>AggregateRoot</code> state is restored from events by calling <code>Apply</code> methods one by one in sequence recorded in <code>eventsequence</code> column. Method mapped as a command handler (see usages of <code>CommandRegistry</code> class to see the mapping) is called on <code>AggregateRoot</code>.</p><p>Events produced by aggregate are published to denormalizers (good example of such is <code>InterviewSummaryDenormalizer</code>). If non of raised an exception during event handling command transaction is committed (<code>UnitOfWorkInScopeExecutor</code> is responsible for wrapping command in transaction).</p><h2 id=public-api>Public API</h2><p>Public api is the one that is intended to be used by any other software that should be integrated with survey solutions. This means that developer should not introduce breaking changes without necessity. Code that relates to public api located in <code>WB.UI.Headquarters/Api/PublicApi</code> folder. It consists of 2 parts, regular api controllers that are documented with swagger and graphql.</p></div></article></div></main><footer class="footer pt-3 pb-1 px-sm-3 px-lg-0"><div class="container copyright"><div class=float-left>&#169; 2016-2025 The World Bank Group.<br>All rights Reserved. <a href=https://www.worldbank.org/en/about/legal _target=blank>Legal</a><br><a class=text-primary href=/about/ _target=blank><b class=text-primary>About the team</b></a>
<a class=text-primary href=https://www.capterra.com/p/153927/Survey-Solutions/ target=_blank>Testimonials</a></div></div></footer><script src=https://code.jquery.com/jquery-3.3.1.min.js integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js></script><script src=https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.min.js></script><script src=/js/asearch.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/5.3.0/ekko-lightbox.min.js></script><script>$(document).on("click",'[data-toggle="lightbox"]',function(e){e.preventDefault(),$(this).ekkoLightbox({alwaysShowClose:!0})})</script></body></html>